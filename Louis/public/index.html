<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸é‹æ•¸å­—æŠ½ç</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; background: #2c2f33; color: white; margin: 0; padding: 20px; }
        .hidden { display: none !important; }
        
        .container { max-width: 500px; margin: 0 auto; background: #23272a; padding: 30px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        
        input { width: 90%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #1a1c1e; color: white; font-size: 1.1em; }
        button { width: 100%; padding: 12px; background: #7289da; color: white; border: none; border-radius: 8px; font-size: 1.2em; cursor: pointer; margin-top: 10px; font-weight: bold;}
        button:hover { background: #5b6eae; }

        .status-box { margin-top: 50px; }
        .status-icon { font-size: 80px; margin-bottom: 20px; display: block; }
        .waiting { color: #aaa; animation: pulse 1.5s infinite; }
        .win { color: #43b581; }
        .lose { color: #f04747; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* ç®¡ç†å“¡å€ */
        #adminPanel { display: none; text-align: left; }
        .player-item { background: #333; padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .cheat-btn { width: auto; padding: 5px 10px; background: #f04747; font-size: 0.9em; margin: 0; }
        
        .config-box { background: #1a1c1e; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #7289da; }
        .config-row { display: flex; gap: 10px; align-items: center; }
        .config-row input { width: 80px; text-align: center; }
        
        /* è½‰ç›¤æ¨£å¼ */
        .wheel-container { position: relative; width: 300px; height: 300px; margin: 20px auto; }
        canvas { width: 100%; height: 100%; }
    </style>
</head>
<body>

    <div id="loginScreen" class="container">
        <h2>ğŸ‰ æ­¡è¿åƒåŠ æŠ½ç</h2>
        <p style="color:#aaa; font-size:0.9em;">è«‹è¼¸å…¥åº§è™Ÿèˆ‡å¹¸é‹æ•¸å­—</p>
        
        <input type="number" id="userseat" placeholder="è«‹è¼¸å…¥åº§è™Ÿ">
        
        <input type="number" id="usernumber" placeholder="ä½ çš„å¹¸é‹æ•¸å­—">
        <p id="rangeHint" style="color: #7289da; font-size: 0.9em; margin-top: -5px;"></p>
        
        <button onclick="joinGame()">åŠ å…¥ç­‰å¾…å®¤</button>
    </div>

    <div id="playerScreen" class="container hidden">
        <div id="waitingView" class="status-box waiting">
            <span class="status-icon">â³</span>
            <h2>ç­‰å¾…ä¸»æŒäººé–‹ç...</h2>
            <p id="playerDisplayInfo"></p>
        </div>

        <div id="winView" class="status-box hidden">
            <span class="status-icon">ğŸ†</span>
            <h2 class="win">æ­å–œï¼ä½ ä¸­çäº†ï¼</h2>
            <p>è«‹èˆ‰æ‰‹é ˜ç</p>
        </div>

        <div id="loseView" class="status-box hidden">
            <span class="status-icon">ğŸ˜¢</span>
            <h2 class="lose">å¾ˆéºæ†¾æ²’ä¸­...</h2>
            <p>ä¸‹æ¬¡å†æ¥å†å²ï¼</p>
        </div>
    </div>

    <div id="adminScreen" class="container hidden">
        <h2 style="text-align: center; color: #7289da;">ğŸ‘‘ ä¸»æŒäººæ§åˆ¶å°</h2>
        
        <div class="config-box">
            <h3 style="margin-top:0;">âš™ï¸ æ•¸å­—ç¯„åœè¨­å®š</h3>
            <div class="config-row">
                <span>æœ€å°:</span>
                <input type="number" id="adminMin" value="1">
                <span>æœ€å¤§:</span>
                <input type="number" id="adminMax" value="100">
                <button onclick="updateConfig()" style="width: auto; padding: 10px; font-size: 1em;">æ›´æ–°</button>
            </div>
        </div>

        <div class="wheel-container">
            <canvas id="wheelCanvas" width="300" height="300"></canvas>
        </div>

        <h3>å·²åŠ å…¥åå–® (åº§è™Ÿ / æ•¸å­—):</h3>
        <div id="playerList"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const isAdmin = new URLSearchParams(window.location.search).has('admin');

        let playersData = {};
        let currentConfig = { min: 1, max: 100 };
        let currentWinnerId = null;

        if (isAdmin) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminScreen').classList.remove('hidden');
            document.getElementById('adminPanel').style.display = 'block'; 
            initWheel();
        }

        socket.on('configUpdate', (config) => {
            currentConfig = { min: config.minNumber, max: config.maxNumber };
            const hintText = `è«‹è¼¸å…¥ ${currentConfig.min} ~ ${currentConfig.max} ä¹‹é–“çš„æ•¸å­—`;
            document.getElementById('usernumber').placeholder = hintText;
            document.getElementById('rangeHint').innerText = hintText;

            if (isAdmin) {
                document.getElementById('adminMin').value = currentConfig.min;
                document.getElementById('adminMax').value = currentConfig.max;
            }
        });

        // --- ç©å®¶é‚è¼¯ (æ”¹ç‚ºå‚³é€ seat) ---
        function joinGame() {
            const seat = document.getElementById('userseat').value;
            const number = parseInt(document.getElementById('usernumber').value);
            
            if(!seat || isNaN(number)) return alert("è«‹å¡«å¯«åº§è™Ÿèˆ‡æ•¸å­—");
            
            if (number < currentConfig.min || number > currentConfig.max) {
                return alert(`æ•¸å­—å¿…é ˆåœ¨ ${currentConfig.min} åˆ° ${currentConfig.max} ä¹‹é–“ï¼`);
            }

            socket.emit('playerLogin', { seat, number });
        }

        socket.on('loginSuccess', (data) => {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('playerScreen').classList.remove('hidden');
            document.getElementById('playerDisplayInfo').innerText = `åº§è™Ÿ: ${data.seat} (çŒœ: ${data.number})`;
        });

        socket.on('loginError', (msg) => {
            alert(msg);
        });

        socket.on('gameResult', (data) => {
            document.getElementById('waitingView').classList.add('hidden');
            if (data.status === 'win') {
                document.getElementById('winView').classList.remove('hidden');
            } else {
                document.getElementById('loseView').classList.remove('hidden');
            }
        });

        // --- ç®¡ç†å“¡é‚è¼¯ ---
        function updateConfig() {
            const min = document.getElementById('adminMin').value;
            const max = document.getElementById('adminMax').value;
            socket.emit('adminSetConfig', { min, max });
            alert("è¨­å®šå·²æ›´æ–°ï¼");
        }

        socket.on('adminUpdate', (players) => {
            if (!isAdmin) return;
            playersData = players;
            renderPlayerList();
            drawWheel();
        });

        function renderPlayerList() {
            const list = document.getElementById('playerList');
            list.innerHTML = '';
            if (Object.keys(playersData).length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#666;">ç­‰å¾…ç©å®¶åŠ å…¥...</p>';
                return;
            }

            Object.values(playersData).forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <span>åº§è™Ÿ: <b>${p.seat}</b> <span style="color:#ffeb3b">(æ•¸å­—:${p.number})</span></span>
                    <button class="cheat-btn" onclick="spinToWinner('${p.id}')">é¸ä»–ä¸­ç</button>
                `;
                list.appendChild(div);
            });
        }

        // --- è½‰ç›¤å‹•ç•« (é¡¯ç¤ºåº§è™Ÿ) ---
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        let currentRotation = 0;

        function drawWheel() {
            const players = Object.values(playersData);
            const count = players.length;
            if (count === 0) {
                ctx.clearRect(0,0,300,300);
                return;
            }

            const arc = (Math.PI * 2) / count;
            const colors = ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#9966FF", "#FF9F40"];
            
            ctx.clearRect(0,0,300,300);
            
            for(let i=0; i<count; i++) {
                ctx.beginPath();
                ctx.fillStyle = colors[i % colors.length];
                ctx.moveTo(150, 150);
                ctx.arc(150, 150, 140, currentRotation + i*arc, currentRotation + (i+1)*arc);
                ctx.lineTo(150, 150);
                ctx.fill();
                
                ctx.save();
                ctx.translate(150, 150);
                ctx.rotate(currentRotation + i*arc + arc/2);
                ctx.fillStyle = "white";
                ctx.font = "bold 16px Arial"; // å­—é«”ç¨å¾®å¤§ä¸€é»
                // é€™è£¡æ”¹æˆé¡¯ç¤ºåº§è™Ÿ
                ctx.fillText(players[i].seat + "è™Ÿ", 60, 5);
                ctx.restore();
            }
            
            ctx.fillStyle = "red";
            ctx.beginPath();
            ctx.moveTo(290, 150);
            ctx.lineTo(300, 140);
            ctx.lineTo(300, 160);
            ctx.fill();
        }

        function initWheel() { drawWheel(); }

        function spinToWinner(socketId) {
            if(confirm("ç¢ºå®šè¦é–‹å§‹æŠ½çå—ï¼Ÿ")) {
                currentWinnerId = socketId;
                let speed = 0.5;
                let decay = 0.005;
                function animate() {
                    currentRotation += speed;
                    speed -= decay;
                    drawWheel();
                    if (speed > 0) {
                        requestAnimationFrame(animate);
                    } else {
                        socket.emit('adminAnnounceWinner', currentWinnerId);
                    }
                }
                animate();
            }
        }
    </script>
</body>
</html>