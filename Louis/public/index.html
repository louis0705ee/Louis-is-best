<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸é‹æ•¸å­—æŠ½ç</title>
    <style>
        /* åŸºç¤è¨­å®šï¼šç™½åº•é»‘å­— */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            text-align: center; 
            background: #ffffff; 
            color: #333333; 
            margin: 0; 
            padding: 20px; 
        }
        .hidden { display: none !important; }
        
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
            background: #f8f9fa; /* æ·ºç°å¡ç‰‡èƒŒæ™¯ */
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            position: relative; 
        }
        
        h2 { color: #2c3e50; font-weight: 800; }
        p { color: #7f8c8d; }

        input { 
            width: 90%; padding: 15px; margin: 10px 0; border-radius: 12px; 
            border: 2px solid #e0e0e0; background: #fff; color: #333; font-size: 1.1em; 
            outline: none; transition: 0.3s;
        }
        input:focus { border-color: #3498db; }

        /* æŒ‰éˆ•æ¨£å¼ */
        button { 
            width: 100%; padding: 15px; background: #3498db; color: white; border: none; 
            border-radius: 12px; font-size: 1.2em; cursor: pointer; margin-top: 10px; font-weight: bold;
            transition: 0.2s; box-shadow: 0 4px 6px rgba(52, 152, 219, 0.3);
        }
        button:active { transform: scale(0.98); }
        button.danger { background: #e74c3c; box-shadow: 0 4px 6px rgba(231, 76, 60, 0.3); }

        /* ä¿®æ”¹å¯†ç¢¼å€å¡Š */
        .btn-small { background: #95a5a6; font-size: 0.9em; padding: 8px; width: auto; box-shadow: none; }
        .change-pass-box { 
            background: #ffffff; padding: 15px; border-radius: 12px; 
            margin-top: 15px; border: 1px solid #e0e0e0; display: none; 
        }

        /* ç‹€æ…‹é¡¯ç¤º */
        .status-icon { font-size: 80px; margin-bottom: 10px; display: block; }
        .waiting { color: #f39c12; animation: pulse 2s infinite; }
        .win { color: #2ecc71; }
        .lose { color: #e74c3c; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* --- ç®¡ç†å“¡å¾Œå°å°ˆç”¨ --- */
        #adminScreen { max-width: 800px; background: #ffffff; box-shadow: none; }
        
        /* é«˜ç´šè¨­å®šæ‘ºç–Šå€ */
        details {
            background: #f8f9fa; padding: 15px; border-radius: 10px;
            margin-bottom: 20px; text-align: left; border: 1px solid #eee;
        }
        summary { cursor: pointer; font-weight: bold; color: #555; outline: none; }

        /* åˆ—è¡¨æ¨£å¼ */
        .player-item { 
            background: #f1f2f6; padding: 12px; margin-bottom: 8px; 
            border-radius: 8px; display: flex; justify-content: space-between; align-items: center; 
        }
        .weight-input { width: 50px; padding: 5px; margin: 0; text-align: center; border: 1px solid #ccc; }

        /* è½‰ç›¤å®¹å™¨ - åŠ å¤§ */
        .wheel-wrapper {
            position: relative;
            width: 400px; 
            height: 400px;
            margin: 20px auto;
        }
        canvas { width: 100%; height: 100%; }
        
        /* æŒ‡é‡ */
        .pointer {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #e74c3c;
            z-index: 10;
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="container">
        <h2 style="color: #3498db;">ğŸ§§ æŠ½çç™»å…¥</h2>
        <p>è«‹è¼¸å…¥ IG å¸³è™ŸåŠ å…¥æŠ½ç</p>
        <input type="text" id="loginUser" placeholder="IG å¸³è™Ÿ">
        <input type="password" id="loginPass" placeholder="å¯†ç¢¼">
        <button onclick="doLogin()">ç™»å…¥</button>
        <p id="loginError" style="color: #e74c3c; display:none;"></p>
    </div>

    <div id="submitScreen" class="container hidden">
        <h2>ğŸ² é¸æ“‡å¹¸é‹æ•¸å­—</h2>
        <h3 id="welcomeText" style="color: #3498db;"></h3>
        
        <button class="btn-small" onclick="toggleChangePass()">ğŸ”‘ ä¿®æ”¹å¯†ç¢¼</button>
        <div id="changePassSection" class="change-pass-box">
            <h4>ä¿®æ”¹å¯†ç¢¼</h4>
            <input type="password" id="oldPass" placeholder="èˆŠå¯†ç¢¼">
            <input type="password" id="newPass" placeholder="æ–°å¯†ç¢¼">
            <button onclick="doChangePass()" style="background:#2ecc71;">ç¢ºèªä¿®æ”¹</button>
            <p id="changePassMsg"></p>
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

        <div id="inputSection">
            <input type="number" id="luckyNumber" placeholder="è¼¸å…¥æ•¸å­—">
            <p id="rangeHint"></p>
            <button onclick="submitNum()">é€å‡ºé¸æ“‡</button>
            <p id="submitError" style="color: #e74c3c; display:none;"></p>
        </div>
    </div>

    <div id="resultScreen" class="container hidden">
        <div id="waitingView" class="hidden">
            <span class="status-icon">â³</span>
            <h2 class="waiting">å·²åƒèˆ‡ï¼ç­‰å¾…é–‹ç...</h2>
            <p id="mySelection" style="font-weight:bold; color:#3498db;"></p>
            
            <button class="btn-small" onclick="toggleChangePassResult()">ğŸ”‘ ä¿®æ”¹å¯†ç¢¼</button>
            <div id="changePassSectionResult" class="change-pass-box">
                <input type="password" id="oldPass2" placeholder="èˆŠå¯†ç¢¼">
                <input type="password" id="newPass2" placeholder="æ–°å¯†ç¢¼">
                <button onclick="doChangePass2()" style="background:#2ecc71;">ç¢ºèªä¿®æ”¹</button>
                <p id="changePassMsg2"></p>
            </div>
        </div>

        <div id="winView" class="hidden">
            <span class="status-icon">ğŸ†</span>
            <h2 class="win">æ­å–œï¼ä½ ä¸­çäº†ï¼</h2>
            <p>è«‹æˆªåœ–çµ¦ Louis é ˜ç</p>
        </div>

        <div id="loseView" class="hidden">
            <span class="status-icon">ğŸ˜¢</span>
            <h2 class="lose">å¾ˆéºæ†¾æ²’ä¸­...</h2>
            <p>ä¸‹æ¬¡é‹æ°£æœƒæ›´å¥½ï¼</p>
        </div>
    </div>

    <div id="adminScreen" class="container hidden">
        <h2>ğŸ›ï¸ å¾Œå°æ§åˆ¶</h2>
        
        <details>
            <summary>âš™ï¸ é«˜ç´šè¨­å®š (ç¯„åœ / é‡ç½®)</summary>
            <div style="margin-top:10px;">
                <label>æ•¸å­—ç¯„åœ:</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="adminMin" value="1">
                    <input type="number" id="adminMax" value="100">
                </div>
                <button onclick="updateConfig()" style="background:#95a5a6; margin-bottom: 20px;">æ›´æ–°ç¯„åœ</button>
                
                <hr>
                <label style="color:#e74c3c; font-weight:bold;">å±éšªå€åŸŸ:</label>
                <button onclick="resetGame()" class="danger">ğŸ—‘ï¸ é‡ç½®éŠæˆ² (æ¸…é™¤æ‰€æœ‰åƒåŠ è€…)</button>
            </div>
        </details>

        <div class="wheel-wrapper">
            <div class="pointer"></div>
            <canvas id="wheelCanvas" width="800" height="800"></canvas>
        </div>
        
        <button onclick="spin()" style="background: #e67e22; font-size: 1.5em; padding: 20px; box-shadow: 0 5px 15px rgba(230, 126, 34, 0.4);">ğŸ° é–‹å§‹æŠ½ç</button>

        <h3 style="text-align:left; margin-top:30px;">ç›®å‰åå–® & æ¬Šé‡:</h3>
        <p style="text-align:left; font-size:0.8em;">(æ¬Šé‡è¶Šé«˜ï¼Œä¸­çæ©Ÿç‡è¶Šå¤§ã€‚æ¯å€‹é¸é …åœ¨è½‰ç›¤ä¸Šçœ‹èµ·ä¾†ä¸€æ¨£å¤§)</p>
        <div id="playerList"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myUsername = "";
        let myNumber = null;
        let playersData = {};
        
        // --- ç™»å…¥é‚è¼¯ ---
        function doLogin() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;
            socket.emit('userLogin', { username: user, password: pass });
        }

        socket.on('loginSuccess', (data) => {
            myUsername = data.username;
            document.getElementById('loginScreen').classList.add('hidden');
            
            if (data.isAdmin) {
                // ç®¡ç†å“¡ -> é€²å¾Œå°
                document.getElementById('adminScreen').classList.remove('hidden');
                initWheel();
            } else {
                // ä¸€èˆ¬ç©å®¶
                if (data.hasSubmitted) {
                    // å·²ç¶“æäº¤é -> é¡¯ç¤ºçµæœ/ç­‰å¾…é 
                    showResultScreen(data.submittedNumber, data.lastWinner);
                } else {
                    // é‚„æ²’æäº¤ -> é¡¯ç¤ºé¸è™Ÿé 
                    document.getElementById('submitScreen').classList.remove('hidden');
                    document.getElementById('welcomeText').innerText = `Hi, ${myUsername}`;
                }
                
                // é è¨­å¯†ç¢¼æç¤º
                if(data.isDefaultPass) {
                     document.getElementById('changePassSection').style.display = 'block';
                }
            }
        });

        socket.on('loginError', (msg) => {
            const el = document.getElementById('loginError');
            el.innerText = msg; el.style.display = 'block';
        });

        // é¡¯ç¤ºçµæœé é¢çš„é‚è¼¯
        function showResultScreen(number, lastWinner) {
            document.getElementById('submitScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            document.getElementById('mySelection').innerText = `ä½ çš„è™Ÿç¢¼ï¼š${number}`;

            if (lastWinner) {
                // å·²é–‹ç
                document.getElementById('waitingView').classList.add('hidden');
                if (lastWinner === myUsername) {
                    document.getElementById('winView').classList.remove('hidden');
                } else {
                    document.getElementById('loseView').classList.remove('hidden');
                }
            } else {
                // å°šæœªé–‹ç
                document.getElementById('waitingView').classList.remove('hidden');
                document.getElementById('winView').classList.add('hidden');
                document.getElementById('loseView').classList.add('hidden');
            }
        }

        // --- æäº¤æ•¸å­— ---
        function submitNum() {
            const num = document.getElementById('luckyNumber').value;
            socket.emit('submitNumber', { username: myUsername, number: num });
        }

        socket.on('submitSuccess', (data) => {
            // æäº¤æˆåŠŸå¾Œï¼Œç›´æ¥è½‰åˆ°ç­‰å¾…ç•«é¢
            showResultScreen(data.number, null);
        });

        socket.on('submitError', (msg) => {
            const el = document.getElementById('submitError');
            el.innerText = msg; el.style.display = 'block';
        });

        // --- å¯†ç¢¼ä¿®æ”¹ (é‡è¤‡çš„ä»£ç¢¼ç°¡åŒ–è™•ç†) ---
        function toggleChangePass() {
            const div = document.getElementById('changePassSection');
            div.style.display = (div.style.display === 'none' || div.style.display === '') ? 'block' : 'none';
        }
        function toggleChangePassResult() {
            const div = document.getElementById('changePassSectionResult');
            div.style.display = (div.style.display === 'none' || div.style.display === '') ? 'block' : 'none';
        }
        function doChangePass() { sendPassChange('oldPass', 'newPass', 'changePassMsg'); }
        function doChangePass2() { sendPassChange('oldPass2', 'newPass2', 'changePassMsg2'); }
        
        function sendPassChange(oldId, newId, msgId) {
            const oldP = document.getElementById(oldId).value;
            const newP = document.getElementById(newId).value;
            if(!newP) return alert("è«‹è¼¸å…¥æ–°å¯†ç¢¼");
            socket.emit('changePassword', { username: myUsername, oldPass: oldP, newPass: newP });
            window.tempMsgId = msgId;
        }

        socket.on('changePasswordSuccess', () => {
            alert("å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼");
            document.querySelectorAll('.change-pass-box').forEach(el => el.style.display = 'none');
        });
        socket.on('changePasswordError', (msg) => {
            if(window.tempMsgId) document.getElementById(window.tempMsgId).innerText = msg;
            else alert(msg);
        });

        // --- éŠæˆ²é‡ç½®ç›£è½ ---
        socket.on('gameReset', () => {
            if(!document.getElementById('adminScreen').classList.contains('hidden')) return; // ç®¡ç†å“¡ä¸å‹•
            alert("éŠæˆ²å·²é‡ç½®ï¼è«‹é‡æ–°é¸è™Ÿã€‚");
            location.reload(); // ç©å®¶é‡æ•´é é¢
        });

        // --- è½‰ç›¤é–‹çå‹•ç•« ---
        socket.on('spinResult', (data) => {
            const { winnerId, winnerName } = data;
            
            // åªæœ‰ç®¡ç†å“¡éœ€è¦è·‘è½‰ç›¤å‹•ç•«
            if (!document.getElementById('adminScreen').classList.contains('hidden')) {
                spinWheelTo(winnerId, winnerName);
            }
        });

        // --- ç®¡ç†å“¡åŠŸèƒ½ ---
        function updateConfig() {
            const min = document.getElementById('adminMin').value;
            const max = document.getElementById('adminMax').value;
            socket.emit('adminSetConfig', { min, max });
            alert("ç¯„åœå·²æ›´æ–°");
        }

        function resetGame() {
            if(confirm("ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿæ‰€æœ‰äººçš„é¸æ“‡éƒ½æœƒè¢«æ¸…é™¤ï¼")) {
                socket.emit('adminResetGame');
            }
        }

        // æ¬Šé‡æ”¹è®Š
        function changeWeight(socketId, val) {
            socket.emit('adminUpdateWeight', { targetSocketId: socketId, newWeight: val });
        }

        socket.on('adminUpdate', (players) => {
            playersData = players;
            renderPlayerList();
            drawWheel(); // éœæ…‹é‡ç¹ª
        });

        socket.on('configUpdate', (config) => {
            document.getElementById('rangeHint').innerText = `è«‹è¼¸å…¥ ${config.minNumber} ~ ${config.maxNumber}`;
            if(document.getElementById('adminMin')) {
                document.getElementById('adminMin').value = config.minNumber;
                document.getElementById('adminMax').value = config.maxNumber;
            }
        });

        function renderPlayerList() {
            const list = document.getElementById('playerList');
            if(!list) return;
            list.innerHTML = '';
            Object.values(playersData).forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <span><b>${p.username}</b> (${p.number})</span>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <small>æ¬Šé‡:</small>
                        <input type="number" class="weight-input" value="${p.weight || 1}" 
                               onchange="changeWeight('${p.id}', this.value)">
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // --- Canvas è½‰ç›¤é‚è¼¯ (é«˜æ¸…ç‰ˆ) ---
        let canvas, ctx;
        let currentRotation = 0; // ç•¶å‰è§’åº¦
        
        function initWheel() {
            canvas = document.getElementById('wheelCanvas');
            ctx = canvas.getContext('2d');
            // ä¿®æ­£è§£æåº¦ (è§£æ±ºæ¨¡ç³Šå•é¡Œ)
            // CSS å¯¬åº¦æ˜¯ 400ï¼Œä½† Canvas å±¬æ€§å¯¬åº¦æ˜¯ 800 (Retina æ”¯æ´)
            drawWheel();
        }

        function drawWheel() {
            if(!ctx) return;
            const players = Object.values(playersData);
            const count = players.length;
            const size = 800;
            const center = size / 2;
            const radius = size / 2 - 20;

            ctx.clearRect(0, 0, size, size);
            
            if (count === 0) { 
                ctx.fillStyle = "#bdc3c7"; ctx.font = "40px Arial"; ctx.textAlign = "center";
                ctx.fillText("ç­‰å¾…åŠ å…¥...", center, center); 
                return; 
            }

            const arc = (Math.PI * 2) / count;
            const colors = ["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF","#FF9F40","#E7E9ED"];
            
            for(let i=0; i<count; i++){
                ctx.beginPath(); 
                ctx.fillStyle = colors[i % colors.length];
                ctx.moveTo(center, center); 
                ctx.arc(center, center, radius, currentRotation + i*arc, currentRotation + (i+1)*arc);
                ctx.fill();
                
                // æ–‡å­— (æ•¸å­—)
                ctx.save(); 
                ctx.translate(center, center); 
                ctx.rotate(currentRotation + i*arc + arc/2);
                ctx.textAlign = "right";
                ctx.fillStyle = "white"; 
                ctx.font = "bold 36px Arial"; 
                ctx.fillText(players[i].number, radius - 20, 10); 
                ctx.restore();
            }
        }

        function spin() {
             if(Object.keys(playersData).length < 1) return alert("æ²’äººä¸èƒ½è½‰ï¼");
             socket.emit('adminSpin'); // è«‹æ±‚å¾Œç«¯è¨ˆç®—çµæœ
        }

        function spinWheelTo(winnerId, winnerName) {
            const players = Object.values(playersData);
            const index = players.findIndex(p => p.id === winnerId);
            if (index === -1) return;

            // è¨ˆç®—ç›®æ¨™è§’åº¦ (è®“æŒ‡é‡æŒ‡åˆ°è©² index)
            // æŒ‡é‡åœ¨ä¸Šæ–¹ (-90åº¦ æˆ– 270åº¦)ï¼Œæ¯å€‹ slice è§’åº¦ = 2PI / count
            const count = players.length;
            const arc = (Math.PI * 2) / count;
            
            // ç›®æ¨™ï¼šè®“è©² slice çš„ä¸­é–“é»å°æº–ä¸Šæ–¹ (3/2 PI)
            // ç•¶å‰ slice ç¯„åœ: [currentRotation + i*arc, currentRotation + (i+1)*arc]
            // æˆ‘å€‘è¦ç®—ä¸€å€‹æ–°çš„ currentRotationï¼Œä½¿å¾—é€™å€‹ slice åœåœ¨æ­£ä¸Šæ–¹
            
            // éš¨æ©Ÿæ—‹è½‰ 5~10 åœˆ
            const rounds = 5 + Math.random() * 5; 
            // è©² slice ç›¸å° 0 åº¦çš„è§’åº¦ä¸­å¿ƒ
            const sliceCenter = index * arc + arc/2;
            
            // ç›®æ¨™è§’åº¦ï¼š3/2 PI (ä¸Šæ–¹) - sliceCenter + å¤šåœˆ
            const targetRotation = (3/2 * Math.PI) - sliceCenter + (rounds * Math.PI * 2);
            
            let start = null;
            const duration = 5000; // 5ç§’
            const startRotation = currentRotation % (Math.PI * 2); // é‡ç½®èµ·å§‹é»ï¼Œé¿å…æ•¸å€¼éå¤§

            function animate(timestamp) {
                if (!start) start = timestamp;
                const progress = (timestamp - start) / duration;
                
                if (progress < 1) {
                    // easeOutCubic ç·©å‹•
                    const ease = 1 - Math.pow(1 - progress, 3); 
                    currentRotation = startRotation + (targetRotation - startRotation) * ease;
                    drawWheel();
                    requestAnimationFrame(animate);
                } else {
                    currentRotation = targetRotation;
                    drawWheel();
                    alert(`ğŸ‰ ä¸­ççš„æ˜¯ï¼š${winnerName}`);
                }
            }
            requestAnimationFrame(animate);
        }
    </script>
</body>
</html>