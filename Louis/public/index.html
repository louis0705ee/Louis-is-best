<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸é‹æ•¸å­—æŠ½çç³»çµ±</title>
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body { 
            font-family: -apple-system, "system-ui", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            text-align: center; 
            background: #ffffff; 
            color: #333; 
            margin: 0; 
            padding: 20px; 
        }
        .hidden { display: none !important; }
        
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
            background: #ffffff; 
            padding: 40px; 
            border-radius: 24px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.08); 
            border: 1px solid #f0f0f0;
            position: relative; /* è®“å³ä¸Šè§’æŒ‰éˆ•å¯ä»¥å®šä½ */
        }
        
        h2 { color: #1a1a1a; font-weight: 800; letter-spacing: -0.5px; margin-top: 0; }
        p { color: #666; font-size: 0.95em; }

        input { 
            width: 90%; padding: 15px; margin: 10px 0; border-radius: 12px; 
            border: 2px solid #eee; background: #fafafa; color: #333; font-size: 1.1em; 
            outline: none; transition: 0.3s;
        }
        input:focus { border-color: #3498db; background: #fff; }

        button { 
            width: 100%; padding: 16px; background: #000; color: white; border: none; 
            border-radius: 14px; font-size: 1.1em; cursor: pointer; margin-top: 15px; font-weight: 600;
            transition: 0.2s;
        }
        button:hover { opacity: 0.9; }
        button:active { transform: scale(0.97); }
        button.danger { background: #ff4757; }

        .btn-small { background: #f1f2f6; color: #57606f; font-size: 0.85em; padding: 8px 15px; width: auto; margin: 10px auto; }
        .change-pass-box { padding: 15px; background: #f9f9f9; border-radius: 10px; margin-top: 10px; }

        /* ç‹€æ…‹å‹•ç•« */
        .status-icon { font-size: 70px; margin-bottom: 15px; display: block; }
        .waiting { color: #ffa502; animation: pulse 2s infinite; }
        .win { color: #2ed573; }
        .lose { color: #ff4757; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* --- å¾Œå°å°ˆç”¨æ¨£å¼ (é‡æ§‹ç‰ˆ) --- */
        #adminScreen { max-width: 900px; padding-top: 50px; } /* å¢åŠ é ‚éƒ¨ç•™ç™½çµ¦æ¨™é¡Œ */

        /* å³ä¸Šè§’è¨­å®šæŒ‰éˆ• */
        .settings-container {
            position: absolute;
            top: 20px;
            right: 25px;
            z-index: 100;
            text-align: right;
        }

        /* éš±è— details é è¨­ç®­é ­ */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }

        .settings-icon {
            font-size: 1.8em;
            cursor: pointer;
            color: #999;
            transition: 0.3s;
            user-select: none;
        }
        .settings-icon:hover { color: #333; transform: rotate(90deg); }

        /* å½ˆå‡ºé¸å–® */
        .settings-dropdown {
            position: absolute;
            right: 0;
            top: 40px;
            width: 300px;
            background: #ffffff;
            border: 1px solid #eee;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-radius: 12px;
            padding: 20px;
            text-align: left;
            z-index: 101;
        }
        
        .settings-dropdown h4 { margin: 0 0 10px 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .settings-dropdown label { font-size: 0.9em; font-weight: bold; color: #666; display: block; margin-top: 10px; }

        /* æ¬Šé‡åˆ—è¡¨ */
        .weight-list-container { 
            max-height: 200px; overflow-y: auto; margin-top: 10px; 
            border: 1px solid #eee; border-radius: 8px;
        }
        .player-item { 
            padding: 8px 12px; border-bottom: 1px solid #f5f5f5; 
            display: flex; justify-content: space-between; align-items: center; font-size: 0.85em;
        }
        .weight-input { width: 50px; padding: 5px; margin:0; text-align: center; border: 1px solid #ddd; }

        /* è½‰ç›¤å”èª¿æ€§å„ªåŒ– */
        .wheel-wrapper {
            position: relative;
            width: 500px;
            height: 500px;
            margin: 20px auto;
        }
        /* ç´…è‰²æŒ‡é‡ (å„ªåŒ–é€ å‹) */
        .pointer {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 50px;
            background: #ff4757;
            clip-path: polygon(50% 100%, 0 0, 100% 0);
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2));
            z-index: 20;
        }
        /* è½‰ç›¤é™°å½± */
        canvas { 
            width: 100%; height: 100%; 
            filter: drop-shadow(0 15px 30px rgba(0,0,0,0.1)); 
            border-radius: 50%;
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="container">
        <h2 style="font-size: 2em; margin-bottom: 10px;">ğŸ§§ æŠ½çç™»å…¥</h2>
        <p>è«‹ä½¿ç”¨ IG å¸³è™Ÿç™»å…¥ç³»çµ±</p>
        <input type="text" id="loginUser" placeholder="IG å¸³è™Ÿ">
        <input type="password" id="loginPass" placeholder="åˆå§‹å¯†ç¢¼: Aa12345678">
        <button onclick="doLogin()">ç™»å…¥ç³»çµ±</button>
        <p id="loginError" style="color: #ff4757; margin-top: 15px; font-weight: bold; display:none;"></p>
    </div>

    <div id="submitScreen" class="container hidden">
        <h2>ğŸ² é¸æ“‡å¹¸é‹æ•¸å­—</h2>
        <h3 id="welcomeText" style="color: #3498db; margin-top: 0;"></h3>
        
        <button class="btn-small" onclick="togglePassBox('changePassSection')">ğŸ”‘ ä¿®æ”¹å¯†ç¢¼</button>
        <div id="changePassSection" class="change-pass-box hidden">
            <input type="password" id="oldPass" placeholder="èˆŠå¯†ç¢¼">
            <input type="password" id="newPass" placeholder="æ–°å¯†ç¢¼">
            <button onclick="doChangePass()" style="background:#2ed573; margin-bottom: 10px;">ç¢ºèªä¿®æ”¹</button>
        </div>

        <div style="margin-top: 30px;">
            <input type="number" id="luckyNumber" placeholder="å¡«å¯«ä½ çš„æ•¸å­—">
            <p id="rangeHint" style="font-size: 0.9em; color: #888;"></p>
            <button onclick="submitNum()" style="background: #3498db;">ç¢ºèªé€å‡ºï¼Œä¸èƒ½æ›´æ”¹</button>
            <p id="submitError" style="color: #ff4757; margin-top: 10px; display:none;"></p>
        </div>
    </div>

    <div id="resultScreen" class="container hidden">
        <div id="waitingView" class="hidden">
            <span class="status-icon">â³</span>
            <h2 class="waiting">å·²æˆåŠŸæŠ•éï¼</h2>
            <p id="mySelection" style="font-size: 1.2em; color: #333;"></p>
            <p>è«‹ç•™æ„ Louis çš„é–‹çå¯¦æ³</p>
            
            <button class="btn-small" onclick="togglePassBox('changePassSectionRes')">ğŸ”‘ ä¿®æ”¹å¯†ç¢¼</button>
            <div id="changePassSectionRes" class="change-pass-box hidden">
                <input type="password" id="oldPass2" placeholder="èˆŠå¯†ç¢¼">
                <input type="password" id="newPass2" placeholder="æ–°å¯†ç¢¼">
                <button onclick="doChangePass2()" style="background:#2ed573;">ç¢ºèªä¿®æ”¹</button>
            </div>
        </div>

        <div id="winView" class="hidden">
            <span class="status-icon">ğŸ†</span>
            <h2 class="win">æ­å–œï¼ä½ ä¸­çäº†ï¼</h2>
            <p>è«‹ç«‹å³æˆªåœ–ä¸¦ç§è¨Š Louis</p>
        </div>

        <div id="loseView" class="hidden">
            <span class="status-icon">ğŸ˜¢</span>
            <h2 class="lose">å¾ˆéºæ†¾æ²’æœ‰ä¸­ç</h2>
            <p>æ„Ÿè¬åƒèˆ‡ï¼Œä¸‹æ¬¡æœƒæ›´å¹¸é‹çš„ï¼</p>
        </div>
    </div>

    <div id="adminScreen" class="container hidden">
        
        <div class="settings-container">
            <details>
                <summary class="settings-icon" title="é«˜ç´šè¨­å®š">âš™ï¸</summary>
                
                <div class="settings-dropdown">
                    <h4>ğŸ› ï¸ é«˜ç´šè¨­å®š</h4>
                    
                    <label>æ•¸å­—ç¯„åœé™åˆ¶ï¼š</label>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="adminMin" placeholder="æœ€å°" style="width:50%;">
                        <input type="number" id="adminMax" placeholder="æœ€å¤§" style="width:50%;">
                    </div>
                    <button onclick="updateConfig()" style="background:#747d8c; padding:10px; font-size:0.9em; margin-top:5px;">æ›´æ–°ç¯„åœ</button>
                    
                    <label>ä¸­çæ¬Šé‡ç®¡ç†ï¼š</label>
                    <div id="weightList" class="weight-list-container">
                        </div>

                    <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
                    <button onclick="resetGame()" class="danger" style="padding:10px; font-size:0.9em; margin-top:0;">ğŸ—‘ï¸ é‡ç½®éŠæˆ²</button>
                </div>
            </details>
        </div>

        <h2 style="font-size: 2.2em; margin-bottom: 5px;">ğŸ‘‘ å¾Œå°ç®¡ç†ç³»çµ±</h2>
        <p style="color:#999;">ç›®å‰åƒåŠ äººæ•¸ï¼š<span id="playerCount" style="color:#333; font-weight:bold;">0</span> äºº</p>

        <div class="wheel-wrapper">
            <div class="pointer"></div>
            <canvas id="wheelCanvas" width="1000" height="1000"></canvas>
        </div>
        
        <button onclick="spin()" style="background: #ffa502; font-size: 1.6em; padding: 20px; box-shadow: 0 8px 20px rgba(255, 165, 2, 0.4); border-radius: 50px;">
            ğŸ¯ é–‹å§‹é–‹ç
        </button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myUsername = "";
        let playersData = {};
        
        // --- ç™»å…¥é‚è¼¯ ---
        function doLogin() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;
            socket.emit('userLogin', { username: user, password: pass });
        }

        socket.on('loginSuccess', (data) => {
            myUsername = data.username;
            document.getElementById('loginScreen').classList.add('hidden');
            
            if (data.isAdmin) {
                document.getElementById('adminScreen').classList.remove('hidden');
                initWheel();
            } else {
                if (data.hasSubmitted) {
                    showResultScreen(data.submittedNumber, data.lastWinner);
                } else {
                    document.getElementById('submitScreen').classList.remove('hidden');
                    document.getElementById('welcomeText').innerText = `ä½ å¥½ï¼Œ${myUsername}`;
                }
                if(data.isDefaultPass) {
                     document.getElementById('changePassSection').classList.remove('hidden');
                }
            }
        });

        socket.on('loginError', (msg) => {
            const el = document.getElementById('loginError');
            el.innerText = msg; el.style.display = 'block';
        });

        function showResultScreen(number, lastWinner) {
            document.getElementById('submitScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            document.getElementById('mySelection').innerText = `ä½ çš„å¹¸é‹æ•¸å­—ï¼š${number}`;

            if (lastWinner) {
                document.getElementById('waitingView').classList.add('hidden');
                if (lastWinner === myUsername) {
                    document.getElementById('winView').classList.remove('hidden');
                } else {
                    document.getElementById('loseView').classList.remove('hidden');
                }
            } else {
                document.getElementById('waitingView').classList.remove('hidden');
            }
        }

        // --- æäº¤èˆ‡å¯†ç¢¼åŠŸèƒ½ ---
        function submitNum() {
            const num = document.getElementById('luckyNumber').value;
            socket.emit('submitNumber', { username: myUsername, number: num });
        }
        socket.on('submitSuccess', (data) => showResultScreen(data.number, null));
        socket.on('submitError', (msg) => { alert(msg); });

        function togglePassBox(id) { document.getElementById(id).classList.toggle('hidden'); }
        function doChangePass() { sendPass('oldPass', 'newPass'); }
        function doChangePass2() { sendPass('oldPass2', 'newPass2'); }
        function sendPass(oid, nid) {
            const op = document.getElementById(oid).value;
            const np = document.getElementById(nid).value;
            socket.emit('changePassword', { username: myUsername, oldPass: op, newPass: np });
        }
        socket.on('changePasswordSuccess', () => alert("ä¿®æ”¹æˆåŠŸï¼"));
        socket.on('changePasswordError', (m) => alert(m));

        // --- å¾Œå°é‚è¼¯ ---
        function updateConfig() {
            socket.emit('adminSetConfig', { 
                min: document.getElementById('adminMin').value, 
                max: document.getElementById('adminMax').value 
            });
            alert("å·²åŒæ­¥ç¯„åœé™åˆ¶");
        }

        function resetGame() {
            if(confirm("ç¢ºå®šè¦é‡ç½®å—ï¼Ÿé€™å°‡æ¸…é™¤ç›®å‰æ‰€æœ‰åƒåŠ è€…çš„å¹¸é‹æ•¸å­—ï¼")) {
                socket.emit('adminResetGame');
            }
        }

        function setWeight(sid, val) {
            socket.emit('adminUpdateWeight', { targetSocketId: sid, newWeight: val });
        }

        socket.on('adminUpdate', (players) => {
            playersData = players;
            document.getElementById('playerCount').innerText = Object.keys(players).length;
            renderWeightList();
            drawWheel();
        });

        function renderWeightList() {
            const list = document.getElementById('weightList');
            list.innerHTML = '';
            const plist = Object.values(playersData);
            if(plist.length === 0) list.innerHTML = '<p style="text-align:center; color:#ccc;">å°šç„¡åƒåŠ è€…</p>';
            plist.forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <span><b>${p.username}</b> (é¸è™Ÿ: ${p.number})</span>
                    <input type="number" class="weight-input" value="${p.weight || 1}" 
                           onchange="setWeight('${p.id}', this.value)">
                `;
                list.appendChild(div);
            });
        }

        // --- å”èª¿æ€§å„ªåŒ–ç‰ˆè½‰ç›¤ ---
        let canvas, ctx, currentRotation = 0;
        function initWheel() {
            canvas = document.getElementById('wheelCanvas');
            ctx = canvas.getContext('2d');
            drawWheel();
        }

        function drawWheel() {
            if(!ctx) return;
            const players = Object.values(playersData);
            const count = players.length;
            const size = 1000;
            const center = size / 2;
            const radius = size / 2 - 20; // ç•™é‚Šè·

            ctx.clearRect(0,0,size,size);
            
            // å¤–æ¡†è£é£¾
            ctx.beginPath();
            ctx.arc(center, center, radius + 10, 0, Math.PI*2);
            ctx.fillStyle = "#333";
            ctx.fill();

            if (count === 0) {
                ctx.beginPath(); ctx.arc(center,center,radius,0,Math.PI*2); ctx.fillStyle = "#eee"; ctx.fill();
                ctx.fillStyle = "#ccc"; ctx.font = "40px Arial"; ctx.textAlign = "center";
                ctx.fillText("ç­‰å¾…ç©å®¶åŠ å…¥...", center, center);
                return;
            }

            const arc = (Math.PI*2)/count;
            const colors = ["#ff4757","#2ed573","#ffa502","#3742fa","#1e90ff","#70a1ff","#a29bfe"];
            
            players.forEach((p, i) => {
                ctx.beginPath();
                ctx.fillStyle = colors[i % colors.length];
                ctx.moveTo(center,center);
                ctx.arc(center,center,radius, currentRotation + i*arc, currentRotation + (i+1)*arc);
                ctx.fill();
                
                // æ–‡å­—
                ctx.save();
                ctx.translate(center,center);
                ctx.rotate(currentRotation + i*arc + arc/2);
                ctx.textAlign = "right"; ctx.fillStyle = "#fff"; ctx.font = "bold 40px Arial";
                ctx.fillText(p.number, radius - 40, 15);
                ctx.restore();
            });

            // --- é—œéµï¼šä¸­å¿ƒè£é£¾è“‹ (Hub) ---
            // é€™è®“è½‰ç›¤çœ‹èµ·ä¾†åƒæ˜¯æœ‰è»¸æ‰¿çš„ï¼Œè§£æ±ºã€Œä¸­é–“å°–å°–çš„ã€ä¸å”èª¿æ„Ÿ
            ctx.beginPath();
            ctx.arc(center, center, 60, 0, Math.PI*2);
            ctx.fillStyle = "#ffffff";
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(center, center, 50, 0, Math.PI*2);
            ctx.fillStyle = "#333";
            ctx.fill();

            // ä¸­å¿ƒæ–‡å­—
            ctx.fillStyle = "#fff";
            ctx.font = "bold 30px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("GO", center, center);
        }

        function spin() { socket.emit('adminSpin'); }

        socket.on('spinResult', (data) => {
            if (document.getElementById('adminScreen').classList.contains('hidden')) return;
            
            const players = Object.values(playersData);
            const idx = players.findIndex(p => p.id === data.winnerId);
            const arc = (Math.PI*2)/players.length;
            const rounds = 8 + Math.random()*5;
            const target = (3/2 * Math.PI) - (idx * arc + arc/2) + (rounds * Math.PI*2);
            
            let start = null;
            function animate(time) {
                if(!start) start = time;
                const prog = (time - start) / 6000;
                if(prog < 1) {
                    const ease = 1 - Math.pow(1 - prog, 4);
                    currentRotation = ease * target;
                    drawWheel();
                    requestAnimationFrame(animate);
                } else {
                    currentRotation = target; drawWheel();
                    alert("ğŸ‰ é–‹ççµæœï¼šä¸­çè€…æ˜¯ " + data.winnerName);
                }
            }
            requestAnimationFrame(animate);
        });

        socket.on('gameReset', () => { if(myUsername && !["louis_chen_0705_1","louis_chen_0705_2"].includes(myUsername)) location.reload(); });
        socket.on('configUpdate', (c) => {
            document.getElementById('rangeHint').innerText = `ç¯„åœé™åˆ¶ï¼š${c.minNumber} ~ ${c.maxNumber}`;
            if(document.getElementById('adminMin')) {
                document.getElementById('adminMin').value = c.minNumber;
                document.getElementById('adminMax').value = c.maxNumber;
            }
        });
    </script>
</body>
</html>
