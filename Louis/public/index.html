<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸é‹æ•¸å­—æŠ½ç</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; background: #2c2f33; color: white; margin: 0; padding: 20px; }
        .hidden { display: none !important; }
        
        /* é€šç”¨å®¹å™¨ */
        .container { max-width: 500px; margin: 0 auto; background: #23272a; padding: 30px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        
        input { width: 90%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #1a1c1e; color: white; font-size: 1.1em; }
        button { width: 100%; padding: 12px; background: #7289da; color: white; border: none; border-radius: 8px; font-size: 1.2em; cursor: pointer; margin-top: 10px; font-weight: bold;}
        button:hover { background: #5b6eae; }

        /* ç‹€æ…‹æ–‡å­— */
        .status-box { margin-top: 50px; }
        .status-icon { font-size: 80px; margin-bottom: 20px; display: block; }
        .waiting { color: #aaa; animation: pulse 1.5s infinite; }
        .win { color: #43b581; }
        .lose { color: #f04747; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* ç®¡ç†å“¡ä»‹é¢ */
        #adminPanel { display: none; text-align: left; }
        .player-item { background: #333; padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .cheat-btn { width: auto; padding: 5px 10px; background: #f04747; font-size: 0.9em; margin: 0; }
        
        /* è½‰ç›¤æ¨£å¼ (åªçµ¦ Admin çœ‹) */
        .wheel-container { position: relative; width: 300px; height: 300px; margin: 20px auto; }
        canvas { width: 100%; height: 100%; }
    </style>
</head>
<body>

    <div id="loginScreen" class="container">
        <h2>ğŸ‰ æ­¡è¿åƒåŠ æŠ½ç</h2>
        <input type="text" id="username" placeholder="ä½ çš„åå­—">
        <input type="number" id="usernumber" placeholder="ä½ çš„å¹¸é‹æ•¸å­—">
        <button onclick="joinGame()">åŠ å…¥ç­‰å¾…å®¤</button>
    </div>

    <div id="playerScreen" class="container hidden">
        <div id="waitingView" class="status-box waiting">
            <span class="status-icon">â³</span>
            <h2>ç­‰å¾…ä¸»æŒäººé–‹ç...</h2>
            <p>è«‹å‹¿é—œé–‰æ­¤é é¢</p>
        </div>

        <div id="winView" class="status-box hidden">
            <span class="status-icon">ğŸ†</span>
            <h2 class="win">æ­å–œä¸­çï¼</h2>
            <p>è«‹å‘ä¸»æŒäººé ˜å–çå“</p>
        </div>

        <div id="loseView" class="status-box hidden">
            <span class="status-icon">ğŸ˜¢</span>
            <h2 class="lose">å¾ˆéºæ†¾æ²’ä¸­...</h2>
            <p>ä¸‹æ¬¡å†æ¥å†å²ï¼</p>
        </div>
    </div>

    <div id="adminScreen" class="container hidden">
        <h2 style="text-align: center; color: #7289da;">ğŸ‘‘ ä¸»æŒäººæ§åˆ¶å°</h2>
        
        <div class="wheel-container">
            <canvas id="wheelCanvas" width="300" height="300"></canvas>
        </div>

        <h3>åœ¨æ­¤æ¬¡å€™é¸åå–®:</h3>
        <div id="playerList"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        // æª¢æŸ¥ç¶²å€æ˜¯å¦æœ‰ ?admin=true
        const isAdmin = new URLSearchParams(window.location.search).has('admin');

        let playersData = {};
        let currentWinnerId = null;

        // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œç›´æ¥é¡¯ç¤ºå¾Œå°
        if (isAdmin) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminScreen').classList.remove('hidden');
            document.getElementById('adminPanel').style.display = 'block'; // ä¿®æ­£é¡¯ç¤ºé‚è¼¯
            initWheel(); // åˆå§‹åŒ–è½‰ç›¤
        }

        // --- ç©å®¶é‚è¼¯ ---
        function joinGame() {
            const name = document.getElementById('username').value;
            const number = document.getElementById('usernumber').value;
            if(!name || !number) return alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");

            socket.emit('playerLogin', { name, number });
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('playerScreen').classList.remove('hidden');
        }

        // ç›£è½çµæœ
        socket.on('gameResult', (data) => {
            document.getElementById('waitingView').classList.add('hidden');
            if (data.status === 'win') {
                document.getElementById('winView').classList.remove('hidden');
                // æ’­æ”¾ä¸­çéŸ³æ•ˆ (é¸æ“‡æ€§)
            } else {
                document.getElementById('loseView').classList.remove('hidden');
            }
        });

        // --- ç®¡ç†å“¡é‚è¼¯ ---
        socket.on('adminUpdate', (players) => {
            if (!isAdmin) return;
            playersData = players;
            renderPlayerList();
            drawWheel(); // æœ‰äººåŠ å…¥å°±é‡ç•«è½‰ç›¤
        });

        function renderPlayerList() {
            const list = document.getElementById('playerList');
            list.innerHTML = '';
            if (Object.keys(playersData).length === 0) {
                list.innerHTML = '<p style="text-align:center; color:#666;">ç­‰å¾…ç©å®¶åŠ å…¥...</p>';
                return;
            }

            Object.values(playersData).forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <span>${p.name} (æ•¸å­—: ${p.number})</span>
                    <button class="cheat-btn" onclick="spinToWinner('${p.id}')">è®“ä»–åœ¨é€™è£¡ä¸­ç</button>
                `;
                list.appendChild(div);
            });
        }

        // --- è½‰ç›¤ç¹ªè£½èˆ‡å‹•ç•«é‚è¼¯ (Admin Only) ---
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        let currentRotation = 0;

        function drawWheel() {
            const players = Object.values(playersData);
            const count = players.length;
            if (count === 0) {
                ctx.clearRect(0,0,300,300);
                return;
            }

            const arc = (Math.PI * 2) / count;
            const colors = ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#9966FF", "#FF9F40"];
            
            ctx.clearRect(0,0,300,300);
            
            for(let i=0; i<count; i++) {
                ctx.beginPath();
                ctx.fillStyle = colors[i % colors.length];
                ctx.moveTo(150, 150);
                ctx.arc(150, 150, 140, currentRotation + i*arc, currentRotation + (i+1)*arc);
                ctx.lineTo(150, 150);
                ctx.fill();
                
                // æ–‡å­—
                ctx.save();
                ctx.translate(150, 150);
                ctx.rotate(currentRotation + i*arc + arc/2);
                ctx.fillStyle = "white";
                ctx.font = "bold 14px Arial";
                ctx.fillText(players[i].name, 60, 5);
                ctx.restore();
            }
            
            // æŒ‡é‡
            ctx.fillStyle = "red";
            ctx.beginPath();
            ctx.moveTo(290, 150);
            ctx.lineTo(300, 140);
            ctx.lineTo(300, 160);
            ctx.fill();
        }

        function initWheel() {
            drawWheel();
        }

        function spinToWinner(socketId) {
            if(confirm("ç¢ºå®šè¦é–‹å§‹æŠ½çå—ï¼Ÿè½‰å®Œå¾Œç©å®¶æœƒæ”¶åˆ°é€šçŸ¥ã€‚")) {
                currentWinnerId = socketId;
                // ç°¡å–®çš„å‹•ç•«æ¨¡æ“¬
                let speed = 0.5;
                let decay = 0.005;
                
                function animate() {
                    currentRotation += speed;
                    speed -= decay;
                    drawWheel();
                    if (speed > 0) {
                        requestAnimationFrame(animate);
                    } else {
                        // åœæ­¢å¾Œï¼Œé€šçŸ¥ä¼ºæœå™¨ç™¼é€çµæœ
                        socket.emit('adminAnnounceWinner', currentWinnerId);
                        alert("å·²ç™¼é€çµæœçµ¦æ‰€æœ‰ç©å®¶ï¼");
                    }
                }
                animate();
            }
        }
    </script>
</body>
</html>