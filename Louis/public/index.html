<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸é‹æ•¸å­—æŠ½ç</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; background: #2c2f33; color: white; margin: 0; padding: 20px; }
        .hidden { display: none !important; }
        
        .container { max-width: 400px; margin: 0 auto; background: #23272a; padding: 30px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); position: relative; }
        
        input { width: 90%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #1a1c1e; color: white; font-size: 1.1em; }
        button { width: 100%; padding: 12px; background: #7289da; color: white; border: none; border-radius: 8px; font-size: 1.2em; cursor: pointer; margin-top: 10px; font-weight: bold;}
        button:hover { background: #5b6eae; }

        .status-box { margin-top: 50px; }
        .status-icon { font-size: 80px; margin-bottom: 20px; display: block; }
        .waiting { color: #aaa; animation: pulse 1.5s infinite; }
        .win { color: #43b581; }
        .lose { color: #f04747; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* ä¿®æ”¹å¯†ç¢¼æ¨£å¼ */
        .btn-small { background: #444; font-size: 0.9em; padding: 8px; margin-top: 5px; width: auto; }
        .change-pass-box { background: #1a1c1e; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #7289da; display: none; }

        /* ç®¡ç†å“¡æ¨£å¼ */
        #adminScreen { max-width: 500px; }
        .player-item { background: #333; padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .cheat-btn { width: auto; padding: 5px 10px; background: #f04747; font-size: 0.9em; margin: 0; }
        .config-box { background: #1a1c1e; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #7289da; }
        
        .wheel-container { position: relative; width: 300px; height: 300px; margin: 20px auto; }
        canvas { width: 100%; height: 100%; }
    </style>
</head>
<body>

    <div id="loginScreen" class="container">
        <h2>ğŸ” IG æ‘¯å‹ç™»å…¥</h2>
        <p style="color:#aaa; font-size:0.9em;">å¸³è™Ÿ: ä½ çš„ IG ID<br>é è¨­å¯†ç¢¼: Aa12345678</p>
        <input type="text" id="loginUser" placeholder="IG å¸³è™Ÿ (ä¾‹å¦‚ louis_chen_0705_1)">
        <input type="password" id="loginPass" placeholder="å¯†ç¢¼">
        <button onclick="doLogin()">ç™»å…¥</button>
        <p id="loginError" style="color: #f04747; display:none;"></p>
    </div>

    <div id="submitScreen" class="container hidden">
        <h2>ğŸ² é¸æ“‡å¹¸é‹æ•¸å­—</h2>
        <h3 id="welcomeText" style="color: #7289da;"></h3>
        
        <button class="btn-small" onclick="toggleChangePass()">ğŸ”‘ ä¿®æ”¹å¯†ç¢¼</button>
        <div id="changePassSection" class="change-pass-box">
            <h4 style="margin:0 0 10px 0;">ä¿®æ”¹å¯†ç¢¼ (é™ä¸€æ¬¡)</h4>
            <input type="password" id="oldPass" placeholder="èˆŠå¯†ç¢¼ (é è¨­: Aa12345678)">
            <input type="password" id="newPass" placeholder="æ–°å¯†ç¢¼ (è«‹å‹™å¿…è¨˜ä½)">
            <button onclick="doChangePass()" style="background:#43b581;">ç¢ºèªä¿®æ”¹</button>
            <p id="changePassMsg" style="font-size:0.9em; margin-top:5px; color:#f04747;"></p>
        </div>

        <hr style="border:0; border-top:1px solid #444; margin: 20px 0;">

        <input type="number" id="luckyNumber" placeholder="è¼¸å…¥æ•¸å­—">
        <p id="rangeHint" style="color: #aaa; font-size: 0.9em;"></p>
        <button onclick="submitNum()">é€å‡ºé¸æ“‡</button>
        <p id="submitError" style="color: #f04747; display:none;"></p>
    </div>

    <div id="resultScreen" class="container hidden">
        <div id="waitingView" class="status-box waiting">
            <span class="status-icon">â³</span>
            <h2>å·²é€å‡ºï¼</h2>
            <p>è«‹ç­‰å¾… Louis é–‹ç...</p>
            <p id="mySelection" style="color:#7289da; font-weight:bold;"></p>
        </div>
        <div id="winView" class="status-box hidden">
            <span class="status-icon">ğŸ†</span>
            <h2 class="win">æ­å–œä¸­çï¼</h2>
        </div>
        <div id="loseView" class="status-box hidden">
            <span class="status-icon">ğŸ˜¢</span>
            <h2 class="lose">å¾ˆéºæ†¾æ²’ä¸­...</h2>
        </div>
    </div>

    <div id="adminScreen" class="container hidden">
        <h2 style="text-align: center; color: #7289da;">ğŸ‘‘ Louis çš„ä½œå¼Šå¾Œå°</h2>
        <div class="config-box">
            <span>ç¯„åœ: </span>
            <input type="number" id="adminMin" value="1" style="width:60px"> ~ 
            <input type="number" id="adminMax" value="100" style="width:60px">
            <button onclick="updateConfig()" style="width:auto; padding:5px 10px;">æ›´æ–°è¨­å®š</button>
        </div>
        <div class="wheel-container">
            <canvas id="wheelCanvas" width="300" height="300"></canvas>
        </div>
        <h3 style="text-align:left;">ç›®å‰åå–® (é»æ“Šå¯ä½œå¼Š):</h3>
        <div id="playerList"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myUsername = "";
        
        // --- ç™»å…¥ ---
        function doLogin() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;
            socket.emit('userLogin', { username: user, password: pass });
        }

        socket.on('loginSuccess', (data) => {
            myUsername = data.username;
            document.getElementById('loginScreen').classList.add('hidden');
            
            if (data.isAdmin) {
                // å¦‚æœæ˜¯ Louisï¼Œç›´æ¥é€²å¾Œå°
                document.getElementById('adminScreen').classList.remove('hidden');
                initWheel();
            } else {
                // å¦‚æœæ˜¯æœ‹å‹ï¼Œé€²é¸è™Ÿç•«é¢
                document.getElementById('submitScreen').classList.remove('hidden');
                document.getElementById('welcomeText').innerText = `Hi, ${myUsername}`;
                
                // å¦‚æœæ˜¯é è¨­å¯†ç¢¼ï¼Œè‡ªå‹•æ‰“é–‹ä¿®æ”¹å¯†ç¢¼æ¡†
                if(data.isDefaultPass) {
                     document.getElementById('changePassSection').style.display = 'block';
                }
            }
        });

        socket.on('loginError', (msg) => {
            const el = document.getElementById('loginError');
            el.innerText = msg; el.style.display = 'block';
        });

        // --- ä¿®æ”¹å¯†ç¢¼ ---
        function toggleChangePass() {
            const div = document.getElementById('changePassSection');
            div.style.display = (div.style.display === 'none' || div.style.display === '') ? 'block' : 'none';
        }

        function doChangePass() {
            const oldP = document.getElementById('oldPass').value;
            const newP = document.getElementById('newPass').value;
            if(!newP) return alert("è«‹è¼¸å…¥æ–°å¯†ç¢¼");
            socket.emit('changePassword', { username: myUsername, oldPass: oldP, newPass: newP });
        }

        socket.on('changePasswordSuccess', () => {
            alert("å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼");
            document.getElementById('changePassSection').style.display = 'none';
            document.getElementById('oldPass').value = "";
            document.getElementById('newPass').value = "";
        });

        socket.on('changePasswordError', (msg) => {
            document.getElementById('changePassMsg').innerText = msg;
        });

        // --- æäº¤æ•¸å­— ---
        function submitNum() {
            const num = document.getElementById('luckyNumber').value;
            socket.emit('submitNumber', { username: myUsername, number: num });
        }

        socket.on('submitSuccess', (data) => {
            document.getElementById('submitScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            document.getElementById('mySelection').innerText = `ä½ çš„é¸æ“‡ï¼š${data.number}`;
        });

        socket.on('submitError', (msg) => {
            const el = document.getElementById('submitError');
            el.innerText = msg; el.style.display = 'block';
        });

        socket.on('configUpdate', (config) => {
            const hint = `è«‹è¼¸å…¥ ${config.minNumber} ~ ${config.maxNumber}`;
            document.getElementById('luckyNumber').placeholder = hint;
            document.getElementById('rangeHint').innerText = hint;
            if(document.getElementById('adminMin')) {
                document.getElementById('adminMin').value = config.minNumber;
                document.getElementById('adminMax').value = config.maxNumber;
            }
        });

        socket.on('gameResult', (data) => {
            document.getElementById('waitingView').classList.add('hidden');
            if (data.status === 'win') document.getElementById('winView').classList.remove('hidden');
            else document.getElementById('loseView').classList.remove('hidden');
        });

        // --- ç®¡ç†å“¡ & è½‰ç›¤é‚è¼¯ ---
        function updateConfig() {
            const min = document.getElementById('adminMin').value;
            const max = document.getElementById('adminMax').value;
            socket.emit('adminSetConfig', { min, max });
            alert("æ›´æ–°æˆåŠŸ");
        }

        let playersData = {};
        socket.on('adminUpdate', (players) => {
            playersData = players;
            renderPlayerList();
            drawWheel();
        });

        function renderPlayerList() {
            const list = document.getElementById('playerList');
            if(!list) return;
            list.innerHTML = '';
            Object.values(playersData).forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `<span><b>${p.username}</b> (${p.number})</span>
                                 <button class="cheat-btn" onclick="spin('${p.id}')">ä¸­ç</button>`;
                list.appendChild(div);
            });
        }

        // è½‰ç›¤ç¹ªè£½
        let canvas, ctx;
        let currentRotation = 0;
        
        function initWheel() {
            canvas = document.getElementById('wheelCanvas');
            ctx = canvas.getContext('2d');
            drawWheel();
        }

        function drawWheel() {
            if(!ctx) return;
            const players = Object.values(playersData);
            const count = players.length;
            ctx.clearRect(0,0,300,300);
            
            if (count === 0) { 
                ctx.fillStyle = "#666"; ctx.font = "16px Arial"; 
                ctx.fillText("ç­‰å¾…åŠ å…¥...", 120, 150); 
                return; 
            }

            const arc = (Math.PI*2)/count;
            const colors = ["#FF6384","#36A2EB","#FFCE56","#4BC0C0","#9966FF","#FF9F40"];
            
            for(let i=0; i<count; i++){
                ctx.beginPath(); 
                ctx.fillStyle=colors[i%6];
                ctx.moveTo(150,150); 
                ctx.arc(150,150,140,currentRotation+i*arc,currentRotation+(i+1)*arc);
                ctx.fill();
                
                ctx.save(); 
                ctx.translate(150,150); 
                ctx.rotate(currentRotation+i*arc+arc/2);
                ctx.fillStyle="white"; 
                ctx.font="bold 14px Arial"; 
                ctx.fillText(players[i].number, 60, 5); 
                ctx.restore();
            }
            ctx.beginPath(); ctx.moveTo(290,150); ctx.lineTo(300,140); ctx.lineTo(300,160); 
            ctx.fillStyle="red"; ctx.fill();
        }

        function spin(id) { 
            if(confirm('ç¢ºå®šè®“é€™å€‹äººä¸­ç?')) {
                let speed=0.5; 
                function ani(){ 
                    currentRotation+=speed; speed-=0.005; drawWheel(); 
                    if(speed>0) requestAnimationFrame(ani); 
                    else socket.emit('adminAnnounceWinner', id);
                } 
                ani(); 
            }
        }
    </script>
</body>
</html>