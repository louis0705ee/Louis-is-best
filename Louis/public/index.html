<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸é‹æ•¸å­—æŠ½ç</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; text-align: center; background: #fff; color: #333; margin: 0; padding: 20px; }
        .hidden { display: none !important; }
        
        .container { 
            max-width: 500px; margin: 0 auto; background: #fff; padding: 20px; 
            border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; position: relative;
        }
        
        h2 { margin-top: 0; color: #222; }
        input { width: 90%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; font-size: 1rem; }
        button { width: 100%; padding: 14px; background: #000; color: #fff; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 10px; transition:0.2s; }
        button:active { transform: scale(0.95); }
        button.danger { background: #ff4757; }
        button.secondary { background: #f1f2f6; color: #333; }
        button.logout { background: #eee; color: #555; font-size: 0.8rem; width: auto; padding: 5px 10px; position: absolute; top: 15px; right: 15px; z-index: 10; }
        
        .wheel-wrapper {
            position: relative; width: 100%; max-width: 450px; aspect-ratio: 1 / 1; margin: 20px auto;
        }
        canvas { width: 100%; height: 100%; border-radius: 50%; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1)); }
        .pointer {
            position: absolute; top: -5%; left: 50%; transform: translateX(-50%);
            width: 40px; height: 50px; background: #ff4757;
            clip-path: polygon(50% 100%, 0 0, 100% 0); z-index: 10;
        }

        .number-inputs-container {
            display: grid; gap: 10px; margin: 15px 0;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        }
        .number-inputs-container input { width: 100%; margin: 0; box-sizing: border-box; text-align: center; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 999; display: flex;
            justify-content: center; align-items: center;
        }
        .modal {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center;
            width: 90%; max-width: 400px;
        }
        .winner-name { font-size: 2em; color: #2ed573; margin: 10px 0; font-weight: 800; }
        .winner-num { font-size: 1.2em; color: #3498db; margin-bottom: 20px; font-weight: bold; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }

        .settings-container { position: absolute; top: 20px; right: 20px; z-index: 50; text-align: right; }
        details > summary { list-style: none; font-size: 1.5rem; cursor: pointer; color: #999; }
        details > summary::-webkit-details-marker { display: none; }
        .settings-dropdown {
            position: absolute; right: 0; top: 40px; width: 280px;
            background: #fff; border: 1px solid #eee; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-radius: 12px; padding: 15px; text-align: left; z-index: 100;
        }
        
        .player-item { padding: 8px 0; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .weight-input { width: 40px; padding: 5px; text-align: center; border: 1px solid #ddd; margin: 0; }
        .status-icon { font-size: 60px; display: block; margin-bottom: 10px; }
        .change-pass-box { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 10px; }
    </style>
</head>
<body>

    <audio id="winSound" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3" preload="auto"></audio>

    <div id="winnerModal" class="modal-overlay hidden">
        <div class="modal">
            <h3>ğŸ‰ æ­å–œä¸­ç ğŸ‰</h3>
            <div id="modalWinnerName" class="winner-name">USER</div>
            <div id="modalWinnerNum" class="winner-num">ä¸­çè™Ÿç¢¼: </div>
            <p>è™•ç†ä¸­çè€…ï¼š</p>
            <div class="modal-actions">
                <button class="danger" onclick="deleteWinner()">ğŸ—‘ï¸ åˆªé™¤</button>
                <button class="secondary" onclick="keepWinner()">â†©ï¸ ä¿ç•™</button>
            </div>
        </div>
    </div>

    <div id="loginScreen" class="container">
        <h2>ğŸ§§ æŠ½çç™»å…¥</h2>
        <input type="text" id="loginUser" placeholder="IG å¸³è™Ÿ">
        <input type="password" id="loginPass" placeholder="å¯†ç¢¼">
        <button onclick="doLogin()">ç™»å…¥</button>
        <p id="loginError" style="color:red; display:none;"></p>
    </div>

    <div id="submitScreen" class="container hidden">
        <button class="logout" onclick="logout()">ç™»å‡º</button>
        <h2 id="welcomeText"></h2>
        
        <button onclick="togglePass('changePassSection')" style="background:#eee; color:#555; font-size:0.9em; width:auto;">ğŸ”‘ æ”¹å¯†ç¢¼</button>
        <div id="changePassSection" class="change-pass-box hidden">
            <input type="password" id="oldPass" placeholder="èˆŠå¯†ç¢¼">
            <input type="password" id="newPass" placeholder="æ–°å¯†ç¢¼">
            <button onclick="changePass('oldPass','newPass')" style="background:#2ed573;">ç¢ºèªä¿®æ”¹</button>
        </div>
        
        <div style="margin-top:20px;">
            <p id="instructionText" style="margin-bottom:5px; font-weight:bold;"></p>
            <div id="dynamicInputs" class="number-inputs-container"></div>
            <p id="rangeHint" style="color:#888; font-size:0.9em;"></p>
            <button onclick="submitNum()" style="background:#3498db;">ç¢ºèªé€å‡º</button>
        </div>
    </div>

    <div id="resultScreen" class="container hidden">
        <button class="logout" onclick="logout()">ç™»å‡º</button>
        
        <div id="waitingView" class="hidden">
            <span class="status-icon">â³</span>
            <h2>å·²åƒåŠ ï¼</h2>
            <p id="mySelection" style="font-weight:bold; font-size:1.1em;"></p>
            <p>ç­‰å¾…é–‹ç...</p>
        </div>
        
        <div id="winView" class="hidden">
            <span class="status-icon">ğŸ†</span>
            <h2 style="color:#2ed573;">æ­å–œä¸­çï¼</h2>
            <p>è«‹æˆªåœ–çµ¦ Louis</p>
        </div>
        
        <div id="loseView" class="hidden">
            <span class="status-icon">ğŸ˜¢</span>
            <h2 style="color:#ff4757;">éºæ†¾æ²’ä¸­...</h2>
            <p>ä¸‹æ¬¡å¥½é‹ï¼</p>
        </div>
    </div>

    <div id="adminScreen" class="container hidden" style="max-width: 600px;">
        <button class="logout" onclick="logout()">ç™»å‡º</button>
        
        <div class="settings-container">
            <details>
                <summary>âš™ï¸</summary>
                <div class="settings-dropdown">
                    <h4>é«˜ç´šè¨­å®š</h4>
                    <label>ç¯„åœ:</label>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="adminMin" placeholder="Min">
                        <input type="number" id="adminMax" placeholder="Max">
                    </div>
                    <label style="margin-top:10px;">å¼·åˆ¶ä½æ•¸ (0=ä¸é™):</label>
                    <input type="number" id="adminDigits" placeholder="0">
                    <label style="margin-top:10px;">æ¯äººé¸æ“‡æ•¸é‡:</label>
                    <input type="number" id="adminCount" value="1" min="1">
                    <button onclick="updateConfig()" style="background:#747d8c; font-size:0.9em;">æ›´æ–°</button>
                    <hr>
                    <div id="weightSection">
                        <label>æ¬Šé‡ç®¡ç†:</label>
                        <div id="weightList" style="max-height:150px; overflow-y:auto; border:1px solid #eee; padding:5px;"></div>
                    </div>
                    <hr>
                    <button onclick="resetGame()" class="danger" style="font-size:0.9em;">ğŸ—‘ï¸ é‡ç½®éŠæˆ²</button>
                </div>
            </details>
        </div>

        <h2>ğŸ‘‘ å¾Œå°ç®¡ç†</h2>
        <p>äººæ•¸: <span id="playerCount">0</span></p>

        <div class="wheel-wrapper">
            <div class="pointer"></div>
            <canvas id="wheelCanvas" width="1000" height="1000"></canvas>
        </div>
        
        <button onclick="spin()" style="background:#ffa502; font-size:1.5em; border-radius:50px; box-shadow:0 5px 15px rgba(255,165,2,0.4);">ğŸ¯ é–‹å§‹é–‹ç</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myUsername = "", amISuperAdmin = false;
        let playersData = {};
        let currentWinnerId = null;
        let selectionCount = 1;

        // --- è‡ªå‹•ç™»å…¥é‚è¼¯ ---
        window.onload = function() {
            const savedUser = localStorage.getItem('ig_user');
            const savedPass = localStorage.getItem('ig_pass');
            if (savedUser && savedPass) {
                // å¦‚æœæœ‰ç´€éŒ„ï¼Œè‡ªå‹•å¡«å…¥ä¸¦å˜—è©¦ç™»å…¥
                document.getElementById('loginUser').value = savedUser;
                document.getElementById('loginPass').value = savedPass;
                socket.emit('userLogin', { username: savedUser, password: savedPass });
            }
        };

        function doLogin() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            socket.emit('userLogin', { username: u, password: p });
        }

        function logout() {
            localStorage.removeItem('ig_user');
            localStorage.removeItem('ig_pass');
            location.reload();
        }

        socket.on('loginSuccess', (data) => {
            myUsername = data.username;
            amISuperAdmin = data.isSuperAdmin;
            
            // ç™»å…¥æˆåŠŸï¼Œå„²å­˜åˆ°ç€è¦½å™¨
            localStorage.setItem('ig_user', document.getElementById('loginUser').value);
            localStorage.setItem('ig_pass', document.getElementById('loginPass').value);

            document.getElementById('loginScreen').classList.add('hidden');
            
            if (data.isAdmin) {
                document.getElementById('adminScreen').classList.remove('hidden');
                initWheel();
            } else {
                if (data.hasSubmitted) {
                    showResult(data.submittedNumbers, data.lastWinner);
                } else {
                    document.getElementById('submitScreen').classList.remove('hidden');
                    document.getElementById('welcomeText').innerText = `Hi, ${myUsername}`;
                }
                if(data.isDefaultPass) document.getElementById('changePassSection').classList.remove('hidden');
            }
        });

        socket.on('loginError', (m) => { 
            document.getElementById('loginError').innerText = m; 
            document.getElementById('loginError').style.display='block'; 
            // å¦‚æœè‡ªå‹•ç™»å…¥å¤±æ•—ï¼Œæ¸…é™¤èˆŠçš„ localStorage
            localStorage.removeItem('ig_user');
            localStorage.removeItem('ig_pass');
        });

        function showResult(numbers, winner) {
            document.getElementById('submitScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            const numsStr = Array.isArray(numbers) ? numbers.join(', ') : numbers;
            document.getElementById('mySelection').innerText = `ä½ çš„é¸æ“‡: ${numsStr}`;
            
            // æ±ºå®šé¡¯ç¤ºå“ªä¸€å€‹ç•«é¢ (ç­‰å¾… vs ä¸­ç vs æ²’ä¸­)
            if(winner) {
                document.getElementById('waitingView').classList.add('hidden');
                if (winner === myUsername) {
                    document.getElementById('winView').classList.remove('hidden');
                    document.getElementById('loseView').classList.add('hidden');
                    launchConfetti();
                } else {
                    document.getElementById('winView').classList.add('hidden');
                    document.getElementById('loseView').classList.remove('hidden');
                }
            } else {
                // é‚„æ²’é–‹ç
                document.getElementById('waitingView').classList.remove('hidden');
                document.getElementById('winView').classList.add('hidden');
                document.getElementById('loseView').classList.add('hidden');
            }
        }

        function submitNum() { 
            const inputs = document.querySelectorAll('#dynamicInputs input');
            let values = [];
            inputs.forEach(input => { if(input.value) values.push(input.value); });
            socket.emit('submitNumber', { username: myUsername, numbers: values }); 
        }
        
        socket.on('submitSuccess', (d) => showResult(d.numbers, null));
        socket.on('submitError', (m) => alert(m));

        function togglePass(id) { document.getElementById(id).classList.toggle('hidden'); }
        function changePass(oid, nid) {
            socket.emit('changePassword', { username: myUsername, oldPass: document.getElementById(oid).value, newPass: document.getElementById(nid).value });
        }
        socket.on('changePasswordSuccess', () => {
            alert('ä¿®æ”¹æˆåŠŸï¼è«‹é‡æ–°ç™»å…¥');
            logout();
        });
        socket.on('changePasswordError', (m) => alert(m));

        // --- å¾Œå° ---
        function updateConfig() { 
            socket.emit('adminSetConfig', { 
                min: document.getElementById('adminMin').value, 
                max: document.getElementById('adminMax').value,
                count: document.getElementById('adminCount').value,
                digits: document.getElementById('adminDigits').value
            }); 
            alert('æ›´æ–°æˆåŠŸ'); 
        }
        function resetGame() { if(confirm('ç¢ºå®šé‡ç½®?')) socket.emit('adminResetGame'); }
        function setWeight(id, val) { if(!amISuperAdmin)return alert('æ¬Šé™ä¸è¶³'); socket.emit('adminUpdateWeight', { adminName: myUsername, targetSocketId: id, newWeight: val }); }

        socket.on('adminUpdate', (players) => {
            playersData = players;
            document.getElementById('playerCount').innerText = Object.keys(players).length;
            renderWeightList();
            drawWheel();
        });

        function renderWeightList() {
            const list = document.getElementById('weightList');
            list.innerHTML = '';
            const plist = Object.values(playersData);
            if(plist.length === 0) return list.innerHTML = '<small>å°šç„¡ç©å®¶</small>';
            plist.forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-item';
                let weightDisplay = amISuperAdmin 
                    ? `<input type="number" class="weight-input" value="${p.weight||1}" onchange="setWeight('${p.id}', this.value)">`
                    : `<span>æ¬Šé‡:${p.weight||1}</span>`;
                const numsStr = Array.isArray(p.numbers) ? p.numbers.join(',') : p.number;
                div.innerHTML = `<span><b>${p.username}</b> [${numsStr}]</span> ${weightDisplay}`;
                list.appendChild(div);
            });
        }

        // --- æ ¸å¿ƒè½‰ç›¤ ---
        let ctx, currentRotation = 0;
        let wheelSlices = []; 

        function initWheel() { ctx = document.getElementById('wheelCanvas').getContext('2d'); drawWheel(); }
        
        function drawWheel() {
            if(!ctx) return;
            const players = Object.values(playersData);
            const size = 1000; const center = 500; const radius = 480;
            ctx.clearRect(0,0,size,size);

            wheelSlices = [];
            players.forEach(p => {
                let nums = Array.isArray(p.numbers) ? p.numbers : [p.number];
                nums.forEach(n => {
                    wheelSlices.push({
                        username: p.username,
                        number: n,
                        id: p.id
                    });
                });
            });

            const count = wheelSlices.length;
            
            if (count === 0) {
                ctx.beginPath(); ctx.arc(center,center,radius,0,Math.PI*2); ctx.fillStyle="#eee"; ctx.fill();
                ctx.fillStyle="#ccc"; ctx.font="40px Arial"; ctx.textAlign="center"; ctx.fillText("ç­‰å¾…åŠ å…¥...", center, center);
                return;
            }

            const arc = (Math.PI*2)/count;
            const colors = ["#ff4757","#2ed573","#ffa502","#3742fa","#1e90ff","#70a1ff","#a29bfe"];
            
            wheelSlices.forEach((slice, i) => {
                ctx.beginPath(); ctx.fillStyle = colors[i%colors.length];
                ctx.moveTo(center,center); ctx.arc(center,center,radius, currentRotation + i*arc, currentRotation + (i+1)*arc); ctx.fill();
                ctx.save(); ctx.translate(center,center); ctx.rotate(currentRotation + i*arc + arc/2);
                ctx.textAlign = "right"; ctx.fillStyle = "#fff"; ctx.font = "bold 35px Arial";
                ctx.fillText(slice.number, radius-40, 15); ctx.restore();
            });

            ctx.beginPath(); ctx.arc(center,center,60,0,Math.PI*2); ctx.fillStyle="#fff"; ctx.fill();
            ctx.beginPath(); ctx.arc(center,center,50,0,Math.PI*2); ctx.fillStyle="#333"; ctx.fill();
            ctx.fillStyle="#fff"; ctx.font="bold 30px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText("GO", center, center);
        }

        function spin() { socket.emit('adminSpin'); }
        
        socket.on('spinResult', (d) => {
            const idx = wheelSlices.findIndex(s => s.id === d.winnerId && s.number == d.winningNumber);
            
            if (idx === -1) return alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ä¸­çåˆ‡ç‰‡");

            const count = wheelSlices.length;
            const arc = (Math.PI*2)/count;
            const target = (3/2 * Math.PI) - (idx * arc + arc/2) + (10 * Math.PI*2);
            let start;
            
            function animate(t) {
                if(!start) start=t;
                const p = (t-start)/6000;
                if(p<1) { 
                    currentRotation = (1 - Math.pow(1-p, 4)) * target; 
                    drawWheel(); requestAnimationFrame(animate); 
                } else { 
                    currentRotation=target; drawWheel(); 
                    document.getElementById('winSound').play().catch(e=>{});
                    launchConfetti();
                    
                    // ğŸ”¥ é—œéµä¿®å¾©ï¼šå‹•ç•«çµæŸå¾Œï¼Œæ‰€æœ‰ç©å®¶ä»‹é¢éƒ½è¦æ›´æ–°æˆã€Œçµæœã€
                    // å¦‚æœæˆ‘æ˜¯ç®¡ç†å“¡
                    if (!document.getElementById('adminScreen').classList.contains('hidden')) {
                        currentWinnerId = d.winnerId;
                        document.getElementById('modalWinnerName').innerText = `${d.winnerName}`;
                        document.getElementById('modalWinnerNum').innerText = `ä¸­çè™Ÿç¢¼: ${d.winningNumber}`;
                        document.getElementById('winnerModal').classList.remove('hidden');
                    } else {
                        // å¦‚æœæˆ‘æ˜¯ç©å®¶ï¼Œæ›´æ–°æˆ‘çš„ç•«é¢
                        // é€™è£¡æˆ‘å€‘ç›´æ¥å‚³ null ä½œç‚ºæ•¸å­—åˆ—è¡¨ï¼Œå› ç‚ºç©å®¶å·²ç¶“çŸ¥é“è‡ªå·±é¸äº†ä»€éº¼ï¼Œé‡é»æ˜¯æ›´æ–° winner
                        // ä½†ç‚ºäº†ä¿éšªï¼Œæˆ‘å€‘åªæ›´æ–° UI ç‹€æ…‹
                        if (d.winnerName === myUsername) {
                            document.getElementById('waitingView').classList.add('hidden');
                            document.getElementById('winView').classList.remove('hidden');
                        } else {
                            document.getElementById('waitingView').classList.add('hidden');
                            document.getElementById('loseView').classList.remove('hidden');
                        }
                    }
                }
            }
            requestAnimationFrame(animate);
        });

        function deleteWinner() {
            if(confirm("åˆªé™¤æ­¤äºº?")) {
                socket.emit('adminDeletePlayer', currentWinnerId);
                document.getElementById('winnerModal').classList.add('hidden');
            }
        }
        function keepWinner() { document.getElementById('winnerModal').classList.add('hidden'); }

        function launchConfetti() {
            var duration = 3000; var end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        socket.on('gameReset', () => { if(!["louis_chen_0705","louis_chen_0705_1","louis_chen_0705_2"].includes(myUsername)) location.reload(); });
        
        socket.on('configUpdate', (c) => { 
            selectionCount = c.selectionCount || 1;
            document.getElementById('rangeHint').innerText = `${c.minNumber}~${c.maxNumber}`;
            document.getElementById('instructionText').innerText = `è«‹é¸æ“‡ ${selectionCount} å€‹æ•¸å­—:`;
            
            const container = document.getElementById('dynamicInputs');
            // åªæœ‰åœ¨é‚„æ²’ç”Ÿæˆéï¼Œæˆ–è€…æ•¸é‡æ”¹è®Šæ™‚æ‰é‡æ–°ç”Ÿæˆï¼Œé¿å…è¼¸å…¥åˆ°ä¸€åŠè¢«æ´—æ‰
            // ä½†ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œé€™è£¡å…ˆä¿æŒé‡ç¹ª
            container.innerHTML = '';
            for(let i=0; i<selectionCount; i++) {
                const input = document.createElement('input');
                input.type = 'number'; input.placeholder = `è™Ÿç¢¼ ${i+1}`;
                container.appendChild(input);
            }

            if(document.getElementById('adminMin')) { 
                document.getElementById('adminMin').value=c.minNumber; 
                document.getElementById('adminMax').value=c.maxNumber;
                document.getElementById('adminCount').value=selectionCount;
                document.getElementById('adminDigits').value=c.digitCount || 0;
            }
        });
    </script>
</body>
</html>
